<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>カルテ番号照合（高精度版）</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #f4f4f4; margin: 0; }
  h1 { font-size: 1.4rem; padding: 10px; background: #333; color: #fff; margin: 0; }
  video { width: 100%; max-width: 600px; border: 2px solid #333; }
  #result { font-size: 1.2rem; margin: 20px; }
  .ok { color: green; font-weight: bold; }
  .ng { color: red; font-weight: bold; }
  #guide {
    position: absolute;
    top: 25%;
    left: 20%;
    width: 60%;
    height: 30%;
    border: 3px dashed rgba(255, 0, 0, 0.6);
    pointer-events: none;
    box-sizing: border-box;
  }
  #controls { margin: 10px; }
  button {
    padding: 8px 16px;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    background: #333;
    color: white;
    cursor: pointer;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<h1>カルテ番号照合（高精度版）</h1>
<div style="position: relative; display: inline-block;">
  <video id="video" autoplay playsinline></video>
  <div id="guide"></div>
</div>
<div id="result">番号スキャン中...</div>
<div id="controls">
  <button onclick="restartScan()">再スキャン</button>
</div>

<script>
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
let scanning = true;
let firstNumber = null;
let recentResults = [];

navigator.mediaDevices.getUserMedia({
  video: {
    facingMode: { exact: "environment" },
    focusMode: "continuous",
    width: { ideal: 1920 },
    height: { ideal: 1080 }
  }
})
.then(stream => {
  video.srcObject = stream;
  startOCR();
})
.catch(err => {
  alert("カメラが利用できません: " + err);
});

function startOCR() {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  setInterval(async () => {
    if (!scanning || video.videoWidth === 0) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // ガイド枠の領域だけ切り取り
    const gx = video.videoWidth * 0.2;
    const gy = video.videoHeight * 0.25;
    const gw = video.videoWidth * 0.6;
    const gh = video.videoHeight * 0.3;

    ctx.drawImage(video, gx, gy, gw, gh, 0, 0, gw, gh);

    // グレースケール＋二値化＋コントラスト強化
    let imageData = ctx.getImageData(0, 0, gw, gh);
    let data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
      let avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
      avg = avg > 150 ? 255 : 0;
      avg = Math.min(255, avg * 1.2);
      data[i] = data[i + 1] = data[i + 2] = avg;
    }
    ctx.putImageData(imageData, 0, 0);

    // OCR（数字のみ）
    const { data: { text, confidence } } = await Tesseract.recognize(canvas, 'eng', {
      tessedit_char_whitelist: '0123456789',
      tessedit_pageseg_mode: 7
    });

    if (confidence < 60) return;

    const matches = text.match(/\d+/g);
    if (matches && matches.length > 0) {
      const currentNumber = matches[0];
      recentResults.push(currentNumber);

      // 最新5件だけ保持
      if (recentResults.length > 5) recentResults.shift();

      // 多数決で安定化
      const stableNumber = getMostFrequent(recentResults);
      resultDiv.innerHTML = `現在検出: ${stableNumber}`;

      if (!firstNumber) {
        firstNumber = stableNumber;
      } else if (firstNumber === stableNumber) {
        resultDiv.innerHTML = `✅ 照合完了 (${stableNumber})`;
        resultDiv.className = 'ok';
        scanning = false;
      }
    }
  }, 1500);
}

function getMostFrequent(arr) {
  const counts = {};
  arr.forEach(num => counts[num] = (counts[num] || 0) + 1);
  return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
}

function restartScan() {
  scanning = true;
  firstNumber = null;
  recentResults = [];
  resultDiv.innerHTML = "番号スキャン中...";
  resultDiv.className = "";
}
</script>
</body>
</html>
